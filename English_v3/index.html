<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“š zyçš„æ™ºèƒ½å•è¯å¡ç‰‡ Â· æ”¶è—+åˆ†ç±»+å‘éŸ³ </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    .card img { transition: transform 0.2s; cursor: pointer; }
    .card:hover img { transform: scale(1.03); }
    .speak-btn { transition: all 0.15s; }
    .speak-btn:active { transform: scale(0.92); }
    .favorite-btn.favorited { color: #ef4444; }
    .word-token {
      display: inline-block;
      padding: 0 2px;
      border-radius: 4px;
      cursor: pointer;
    }
    .word-token:hover {
      background-color: #dbeafe;
    }
  </style>
</head>
<body class="bg-gray-50 p-4">

  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold text-center mb-4 text-gray-800">ğŸ“š zyçš„æ™ºèƒ½å•è¯å¡ç‰‡</h1>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="mb-6 flex flex-col sm:flex-row gap-3">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="ğŸ” æ¨¡ç³Šæœç´¢ï¼ˆè‹±æ–‡/ä¸­æ–‡/åˆ†ç±»ï¼‰..." 
        class="flex-1 p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm"
      />
      
      <div class="flex gap-2">
        <button id="viewAll" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">å…¨éƒ¨</button>
        <button id="viewFavorites" class="px-4 py-2 bg-pink-100 rounded-lg hover:bg-pink-200">æ”¶è—</button>
        <button id="startReview" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">å¼€å§‹å¤ä¹ </button>
      </div>
    </div>

    <div id="categoryFilters" class="mb-4 flex flex-wrap gap-2"></div>

    <div id="cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <script src="words.js"></script>
  
<script src="iseda.js"></script> <!-- æ–°å¢2ï¼šå•è¯è¡¥å…… --> 

  <script src="reviewModule.js"></script> <!-- æ–°å¢1 -->

  <script>
    // ========== æ ¸å¿ƒåŠŸèƒ½å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
    function speakText(text, lang = 'en-US') {
      if (!('speechSynthesis' in window)) {
        alert('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge');
        return;
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      utterance.rate = 1.0;
      speechSynthesis.speak(utterance);
    }

    function searchImage(keyword) {
      const url = `https://image.baidu.com/search/index?tn=baiduimage&word=${encodeURIComponent(keyword)}`;
      window.open(url, '_blank');
    }

    // ========== ã€é‡ç‚¹ä¿®æ”¹ã€‘ï¼šæ›¿æ¢ fuzzyMatch å’Œ filterWords ==========
    
    // å­åºåˆ—åˆ¤æ–­ï¼ˆç”¨äºè·³å­—ç¬¦åŒ¹é…ï¼‰
    function isSubsequence(str, pattern) {
      if (!pattern) return true;
      let i = 0, j = 0;
      while (i < str.length && j < pattern.length) {
        if (str[i] === pattern[j]) j++;
        i++;
      }
      return j === pattern.length;
    }

    // å¼ºæ¨¡ç³ŠåŒ¹é…å‡½æ•°ï¼ˆæ›¿ä»£åŸæ¥çš„ fuzzyMatchï¼‰
    function strongFuzzyMatch(item, query) {
      if (!query) return true;
      const q = query.trim().toLowerCase();
      const cleanQ = q.replace(/\s+/g, '');

      // 1. åŸå­—æ®µç›´æ¥åŒ…å«ï¼ˆè‹±æ–‡å°å†™ / ä¸­æ–‡åŸè¯ï¼‰
      if (
        item.word.toLowerCase().includes(q) ||
        item.translation.includes(query) ||
        (item.extension && item.extension.toLowerCase().includes(q)) ||
        (item.category && item.category.toLowerCase().includes(q))
      ) {
        return true;
      }

      // 2. è‹±æ–‡è·³å­—ç¬¦åŒ¹é…
      if (isSubsequence(item.word.toLowerCase(), cleanQ)) {
        return true;
      }

      // 3. ä¸­æ–‡å…³é”®è¯åŒ¹é…ï¼ˆtranslation + extensionï¼‰
      const chineseCombined = item.translation + ' ' + (item.extension || '');
      if (chineseCombined.includes(query)) {
        return true;
      }

      // 4. æ‹¼éŸ³åŒ¹é…ï¼ˆä¾èµ– words.js ä¸­çš„ pinyin å­—æ®µï¼‰
      if (item.pinyin) {
        const pyNoSpace = item.pinyin.toLowerCase().replace(/\s+/g, ''); // "wuxianshubiao"
        const firstLetters = item.pinyin.split(/\s+/).map(p => p.charAt(0)).join(''); // "wxsb"

        if (
          pyNoSpace.includes(cleanQ) ||           // å…¨æ‹¼åŒ…å«
          firstLetters.includes(cleanQ) ||        // é¦–å­—æ¯åŒ…å«
          isSubsequence(pyNoSpace, cleanQ)        // æ‹¼éŸ³è·³å­—ç¬¦
        ) {
          return true;
        }
      }

      return false;
    }

    // æ›¿æ¢åŸæ¥çš„ filterWords
    function filterWords(words, query) {
      return words.filter(item => strongFuzzyMatch(item, query));
    }

    // ========== æ”¶è—ç®¡ç†ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
    const FAVORITES_KEY = 'word_favorites_v2';

    function getFavorites() {
      const data = localStorage.getItem(FAVORITES_KEY);
      return data ? JSON.parse(data) : [];
    }

    function saveFavorites(favs) {
      localStorage.setItem(FAVORITES_KEY, JSON.stringify(favs));
    }

    function isFavorited(word) {
      return getFavorites().some(f => f.word === word);
    }

    function toggleFavorite(word) {
      const favs = getFavorites();
      const exists = favs.findIndex(f => f.word === word);
      if (exists >= 0) {
        favs.splice(exists, 1);
      } else {
        favs.push({ word, timestamp: Date.now() });
      }
      saveFavorites(favs);
      renderCards();
    }

    // ========== ä¾‹å¥åˆ†è¯å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
    function splitSentenceToSpans(sentence, lang = 'en-US') {
      if (!sentence) return '';
      return sentence.split(/(\s+)/)
        .map(token => {
          if (/^\s*$/.test(token)) return token;
          const cleanWord = token.replace(/[.,!?;:()\[\]"'â€”â€“â€¦]/g, '');
          if (!cleanWord) return token;
          return `<span class="word-token"
                        onclick="event.stopPropagation(); speakText('${cleanWord.replace(/'/g, "\\'")}', '${lang}')">${token}</span>`;
        })
        .join('');
    }

    // ========== æ¸²æŸ“é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
    let currentView = 'all';
    let currentSearchQuery = '';

    function getAllCategories() {
      const cats = new Set();
      WORDS.forEach(w => {
        if (w.category) cats.add(w.category);
      });
      return Array.from(cats).sort();
    }

    function renderCategoryFilters() {
      const container = document.getElementById('categoryFilters');
      const categories = getAllCategories();
      if (categories.length === 0) {
        container.innerHTML = '';
        return;
      }

      let html = '<span class="text-sm font-medium text-gray-600 mr-2">åˆ†ç±»ï¼š</span>';
      html += `<button class="px-3 py-1 text-sm rounded ${currentView === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200'}" onclick="setView('all')">å…¨éƒ¨</button>`;
      
      categories.forEach(cat => {
        const isActive = currentView === `category:${cat}`;
        html += `
          <button class="px-3 py-1 text-sm rounded ${isActive ? 'bg-blue-500 text-white' : 'bg-gray-200'}"
                  onclick="setView('category:${cat}')">
            ${cat}
          </button>
        `;
      });
      container.innerHTML = html;
    }

    function setView(view) {
      currentView = view;
      renderCategoryFilters();
      renderCards();
    }

    function renderCards() {
      const container = document.getElementById('cards-container');
      let wordsToShow = [];

      if (currentView === 'favorites') {
        const favs = getFavorites();
        const favWordSet = new Set(favs.map(f => f.word));
        wordsToShow = WORDS.filter(w => favWordSet.has(w.word));
        wordsToShow.sort((a, b) => {
          const timeA = favs.find(f => f.word === a.word)?.timestamp || 0;
          const timeB = favs.find(f => f.word === b.word)?.timestamp || 0;
          return timeB - timeA;
        });
      } else if (currentView.startsWith('category:')) {
        const cat = currentView.split(':')[1];
        wordsToShow = WORDS.filter(w => w.category === cat);
      } else {
        wordsToShow = [...WORDS];
      }

      const filtered = filterWords(wordsToShow, currentSearchQuery);
      container.innerHTML = '';

      if (filtered.length === 0) {
        container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">æœªæ‰¾åˆ°åŒ¹é…å†…å®¹</p>';
        return;
      }

      filtered.forEach(item => {
        const keyword = item.word || item.translation;
        const favorited = isFavorited(item.word);

        const example1HTML = splitSentenceToSpans(item.example1, 'en-US');
        const example1TransHTML = splitSentenceToSpans(item.example1Translation, 'zh-CN');

        // âœ… æ–°å¢ï¼šè¯æ€§ï¼Œæ²¡å†™å°±é»˜è®¤ n.
        const pos = item.pos || "n.";

        const card = document.createElement('div');
        card.className = 'rounded-xl overflow-hidden shadow-md bg-white hover:shadow-lg transition-shadow';

        card.innerHTML = `
          <div class="relative">
            <div class="h-40 bg-emerald-50 flex items-center justify-center border-b border-emerald-100"
                onclick="searchImage('${keyword.replace(/'/g, "\\'")}'); event.stopPropagation();">
              <div class="text-center px-4">
                <!-- ä¸Šé¢ä¸€æ¡å°èƒ¶å›Šï¼Œå†™â€œç™¾åº¦æœå›¾â€ -->
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/80 shadow-sm mb-2">
                  <i class="fas fa-image text-emerald-500 text-base"></i>
                  <span class="text-xs font-medium text-emerald-700">ç™¾åº¦æœå›¾</span>
                </div>

                <!-- ä¸‹é¢æ˜¾ç¤ºå…³é”®è¯ -->
                <p class="text-sm text-emerald-900">
                  <span class="font-semibold">${keyword}</span>
                </p>
              </div>
            </div>
            <button class="absolute top-2 right-2 favorite-btn ${favorited ? 'favorited' : ''}" 
                    onclick="event.stopPropagation(); toggleFavorite('${item.word.replace(/'/g, "\\'")}');">
              <i class="fas fa-heart text-lg"></i>
            </button>
            ${item.category ? `<div class="absolute bottom-2 left-2 bg-blue-500 text-white text-xs px-2 py-1 rounded">${item.category}</div>` : ''}
          </div>
          <div class="p-4">
            <div class="flex items-baseline gap-2">
              <span class="text-lg font-semibold text-gray-800">${item.word}</span>
              <span class="text-xs text-gray-500 cursor-pointer hover:text-blue-600" 
                    onclick="event.stopPropagation(); speakText('${item.word.replace(/'/g, "\\'")}', 'en-US')">
                ${item.ipa || ''}
              </span>
            </div>

            <div class="mt-2">
              <span class="text-xs italic text-gray-500">${pos}</span>
              <span class="text-gray-700">${item.translation}</span>
            </div>

            <div class="mt-3">
              <div class="flex items-start gap-2">
                <button class="speak-btn bg-green-500 hover:bg-green-600 text-white rounded-full w-7 h-7 flex items-center justify-center mt-0.5"
                        onclick="event.stopPropagation(); speakText('${item.example1.replace(/'/g, "\\'")}', 'en-US')">
                  <i class="fas fa-play text-[10px]"></i>
                </button>
                <p class="text-sm text-gray-700">${example1HTML}</p>
              </div>
            </div>

            <p class="text-sm text-gray-700 mt-2">${example1TransHTML}</p>

            <div class="mt-3 pt-2 border-t border-gray-100">
              <p class="text-sm text-gray-600">${item.extension}</p>
            </div>
          </div>
        `;

        container.appendChild(card);
      });
    }

    // ========== åˆå§‹åŒ–ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('viewAll').addEventListener('click', () => setView('all'));
      
      document.getElementById('viewFavorites').addEventListener('click', () => setView('favorites'));

      document.getElementById('startReview').addEventListener('click', () => {
         WordReview.start(WORDS);
         });

      document.getElementById('searchInput').addEventListener('input', (e) => {
        currentSearchQuery = e.target.value;
        renderCards();
      });

      renderCategoryFilters();
      renderCards();
    });
  </script>
</body>
</html>